<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fitness Challenge Portal</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  :root { --bg:#0b0d10; --card:#12161b; --muted:#9aa4af; --text:#e6edf3; --acc:#4ade80; --warn:#fbbf24; --err:#f87171; }
  *{box-sizing:border-box}
  body{margin:0;background:linear-gradient(180deg,#0b0d10,#0e1216);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  .container{max-width:980px;margin:0 auto;padding:24px}
  header{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:1.6rem;margin:0}
  .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px;margin:12px 0;box-shadow:0 4px 24px rgba(0,0,0,.35)}
  label{display:block;font-weight:600;margin:10px 0 6px}
  input,select,button,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #273241;background:#0f1318;color:var(--text)}
  .btn{background:#1f2937;border:1px solid #2b3746;cursor:pointer;transition:.15s transform ease, .2s background ease}
  .btn:hover{background:#243041;transform:translateY(-1px)}
  .btn-primary{background:linear-gradient(90deg,#10b981,#22c55e);border:none;color:#062714;font-weight:700}
  .grid{display:grid;gap:12px}
  .grid-2{grid-template-columns:1fr 1fr}
  .grid-3{grid-template-columns:repeat(3,1fr)}
  @media(max-width:800px){.grid-2,.grid-3{grid-template-columns:1fr}}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  th,td{padding:10px;border-bottom:1px solid #1f2937;text-align:left}
  th{color:#cbd5e1;font-weight:700}
  .badge{display:inline-block;border-radius:999px;padding:4px 10px;font-size:.8rem}
  .ok{color:#0f5132;background:#d1fae5;border:1px solid #34d399}
  .err{color:#7f1d1d;background:#fee2e2;border:1px solid #f87171}
  .muted{color:var(--muted);font-size:.95rem}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:6px 0 12px}
  .tab{padding:8px 12px;border-radius:12px;border:1px solid #2b3746;background:#0f1318;color:#cbd5e1;cursor:pointer}
  .tab.active{background:#1f2937;color:#fff}
  .progress{background:#0f172a;border:1px solid #334155;border-radius:999px;height:10px;width:100%;overflow:hidden}
  .progress>span{display:block;height:100%;background:linear-gradient(90deg,#10b981,#22c55e);width:0%}
  footer{margin-top:20px;color:#94a3b8;font-size:.9rem}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .note{font-size:.9rem;color:#cbd5e1}
</style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Fitness Challenge Portal</h1>
      <div class="inline">
        <span class="badge" style="background:#111827;border:1px solid #2b3746;color:#cbd5e1">Oct 3 → Jan 1</span>
        <span class="badge" style="background:#0f172a;border:1px solid #334155;color:#cbd5e1" id="baselineTag">Baseline: 5 hr/wk</span>
      </div>
    </header>

    <div class="tabs">
      <button class="tab" data-tab="baseline">Baseline</button>
      <button class="tab active" data-tab="hours">Weekly Hours</button>
      <button class="tab" data-tab="checkin">Monthly Check-in</button>
      <button class="tab" data-tab="board">Leaderboard</button>
      <button class="tab" data-tab="info">Info</button>
    </div>

    <!-- Baseline -->
    <section id="baseline" class="card" style="display:none">
      <h2>Submit Baseline (Start & Target)</h2>
      <div class="grid grid-3">
        <div>
          <label>Name</label>
          <select id="bName"></select>
        </div>
        <div>
          <label>Goal Category</label>
          <select id="bCat">
            <option value="">Select</option>
            <option value="Weight Loss">Weight Loss (lb)</option>
            <option value="Mile Time">Mile Time (sec)</option>
            <option value="Bench Weight">Bench Weight (lb)</option>
          </select>
        </div>
        <div>
          <label>Start Value</label>
          <input id="bStart" type="number" step="0.01" placeholder="e.g., 185 or 540" />
        </div>
      </div>
      <div class="grid grid-2">
        <div>
          <label>Target Value</label>
          <input id="bTarget" type="number" step="0.01" placeholder="e.g., 200 or 420" />
        </div>
        <div>
          <label>Notes (optional)</label>
          <input id="bNotes" placeholder="Any context for the admins" />
        </div>
      </div>
      <p class="note">Admins will review baselines and copy them into the official Roster.</p>
      <div class="inline" style="margin-top:10px">
        <button class="btn btn-primary" id="bSubmit">Submit Baseline</button>
        <span id="bMsg" class="badge muted"></span>
      </div>
    </section>

    <!-- Hours -->
    <section id="hours" class="card">
      <h2>Submit Weekly Hours</h2>
      <div class="grid grid-3">
        <div>
          <label>Name</label>
          <select id="hName"></select>
        </div>
        <div>
          <label>Week # (1–13)</label>
          <input id="hWeek" type="number" min="1" max="13" placeholder="e.g., 1" />
        </div>
        <div>
          <label>Total Hours</label>
          <input id="hHours" type="number" step="0.1" min="0" placeholder="e.g., 5.0" />
        </div>
      </div>
      <label>Dates (optional)</label>
      <input id="hDates" placeholder="e.g., Oct 3 – Oct 9">
      <label>Notes (optional)</label>
      <input id="hNotes" placeholder="Optional notes">
      <div class="inline" style="margin-top:10px">
        <button class="btn btn-primary" id="hSubmit">Submit Hours</button>
        <span id="hMsg" class="badge muted"></span>
      </div>

      <!-- NEW: Visuals -->
      <div class="card" style="margin-top:16px">
        <div class="inline" style="justify-content:space-between">
          <h3 style="margin:0">Weekly Hours — Progress to Minimum</h3>
          <button class="btn" id="refreshHours">Refresh</button>
        </div>
        <canvas id="hoursChart" height="120"></canvas>
        <div id="hoursBars" style="margin-top:12px"></div>
      </div>
    </section>

    <!-- Check-ins -->
    <section id="checkin" class="card" style="display:none">
      <h2>Submit Monthly Check-in</h2>
      <div class="grid grid-3">
        <div>
          <label>Name</label>
          <select id="cName"></select>
        </div>
        <div>
          <label>Goal Category</label>
          <select id="cCat">
            <option value="">Select</option>
            <option value="Weight Loss">Weight Loss (lb)</option>
            <option value="Mile Time">Mile Time (sec)</option>
            <option value="Bench Weight">Bench Weight (lb)</option>
          </select>
        </div>
        <div>
          <label>Date</label>
          <input id="cDate" type="date" />
        </div>
      </div>
      <label>Current Value (number)</label>
      <input id="cValue" type="number" step="0.01" placeholder="Number only" />
      <p class="note">Pick which goal you’re updating. Example: Mile → enter seconds (e.g., 420 for 7:00).</p>
      <div class="inline" style="margin-top:10px">
        <button class="btn btn-primary" id="cSubmit">Submit Check-in</button>
        <span id="cMsg" class="badge muted"></span>
      </div>
    </section>

    <!-- Leaderboard -->
    <section id="board" class="card" style="display:none">
      <div class="inline" style="justify-content:space-between">
        <h2>Leaderboard</h2>
        <button id="refreshBoard" class="btn">Refresh</button>
      </div>
      <table>
        <thead>
          <tr>
            <th>#</th><th>Name</th><th>Category</th><th>Start → Target</th>
            <th>Progress</th><th>Consistency</th><th>Final</th>
          </tr>
        </thead>
        <tbody id="boardBody">
          <tr><td colspan="7" class="muted">Loading…</td></tr>
        </tbody>
      </table>
      <p class="note" style="margin-top:8px">Tie-breaker: higher consistency wins; then bonus/community vote if enabled.</p>
    </section>

    <section id="info" class="card" style="display:none">
      <h2>How it Works</h2>
      <ul>
        <li>Baseline: <b>5 hours/week</b> logged (editable in <b>Settings!B3</b>).</li>
        <li>Categories: <b>Weight Loss (lb)</b>, <b>Mile Time (sec)</b>, <b>Bench Weight (lb)</b>.</li>
        <li>Monthly check-ins (Nov 1, Dec 1, Jan 1) recommended.</li>
      </ul>
      <p class="muted">Update <code>WEBAPP_URL</code>, <code>SECRET</code>, and <code>CONTESTANTS</code> in this file. Re-deploy Apps Script after code changes.</p>
    </section>

    <footer class="container" style="padding:0">
      <span class="muted">© Fitness Challenge</span>
    </footer>
  </div>

<script>
// === CONFIG ===
const WEBAPP_URL = 'YOUR_APPS_SCRIPT_WEBAPP_URL';
const SECRET = 'YOUR_LONG_RANDOM_SECRET';
const CONTESTANTS = ['Jared','Daniel','Morgan','Caleb','Randy','Cindy','Contestant 7','Contestant 8'];

// Header tag
document.getElementById('baselineTag').textContent = 'Baseline: 5 hr/wk';

// Populate dropdowns
function fillNames(){
  const selects = ['bName','hName','cName'].map(id=>document.getElementById(id)).filter(Boolean);
  selects.forEach(s => s.innerHTML = '<option value="">Select</option>' + CONTESTANTS.map(n=>`<option>${n}</option>`).join(''));
}
fillNames();

// Tabs
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tab = btn.dataset.tab;
    ['baseline','hours','checkin','board','info'].forEach(id=>{
      document.getElementById(id).style.display = (id===tab)?'block':'none';
    });
    if(tab==='board') loadBoard();
    if(tab==='hours') loadHoursVisual();
  });
});

// Robust fetch helper (shows server output in console if not JSON)
async function postJSON(payload){
  try{
    const res = await fetch(WEBAPP_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({...payload, secret: SECRET})
    });
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { console.error('Non-JSON response:', text); return { ok:false, error:'Non-JSON response' }; }
  }catch(err){ console.error('Fetch failed:', err); return { ok:false, error:'Fetch failed' }; }
}
async function getJSON(){
  try{
    const res = await fetch(WEBAPP_URL);
    const text = await res.text();
    try { return JSON.parse(text); }
    catch { console.error('Non-JSON response:', text); return { ok:false, error:'Non-JSON response' }; }
  }catch(err){ console.error('Fetch failed:', err); return { ok:false, error:'Fetch failed' }; }
}

function badge(el, ok, msg){
  el.textContent = msg;
  el.className = 'badge ' + (ok ? 'ok' : 'err');
}

// Submit Baseline
document.getElementById('bSubmit').onclick = async () => {
  const name = document.getElementById('bName').value.trim();
  const category = document.getElementById('bCat').value;
  const start = Number(document.getElementById('bStart').value);
  const target = Number(document.getElementById('bTarget').value);
  const notes = document.getElementById('bNotes').value;
  const msg = document.getElementById('bMsg');
  if(!name || !category || isNaN(start) || isNaN(target)){ badge(msg,false,'Fill name, category, start, target'); return; }
  const r = await postJSON({type:'baseline', name, category, start, target, notes});
  badge(msg, r.ok, r.ok ? 'Baseline submitted! (Admins will review)' : ('Error: ' + (r.error||'unknown')));
};

// Submit Weekly Hours
document.getElementById('hSubmit').onclick = async () => {
  const name = document.getElementById('hName').value.trim();
  const week = Number(document.getElementById('hWeek').value);
  const hours = Number(document.getElementById('hHours').value);
  const dates = document.getElementById('hDates').value;
  const notes = document.getElementById('hNotes').value;
  const msg = document.getElementById('hMsg');
  if(!name || !week || isNaN(hours)){ badge(msg,false,'Please fill name, week, and hours'); return; }
  const r = await postJSON({type:'hours', name, week, dates, hours, notes});
  badge(msg, r.ok, r.ok ? 'Hours submitted!' : ('Error: ' + (r.error||'unknown')));
  if (r.ok) loadHoursVisual();
};

// Submit Check-in
document.getElementById('cSubmit').onclick = async () => {
  const name = document.getElementById('cName').value.trim();
  const cat = document.getElementById('cCat').value;
  const date = document.getElementById('cDate').value;
  const current = Number(document.getElementById('cValue').value);
  const msg = document.getElementById('cMsg');
  if(!name || !cat || !date || isNaN(current)){ badge(msg,false,'Fill name, category, date, and current value'); return; }
  const r = await postJSON({type:'checkin', name, category: cat, date, current});
  badge(msg, r.ok, r.ok ? 'Check-in submitted!' : ('Error: ' + (r.error||'unknown')));
};

// Leaderboard
document.getElementById('refreshBoard').onclick = loadBoard;
async function loadBoard(){
  const tb = document.getElementById('boardBody');
  tb.innerHTML = '<tr><td colspan="7" class="muted">Loading…</td></tr>';
  const data = await getJSON();
  if(!data.ok){ tb.innerHTML = '<tr><td colspan="7">Error loading board</td></tr>'; return; }
  const rows = (data.leaderboard || []).filter(r=>r['#']!=='' && r['#']!=null)
                   .sort((a,b)=>(Number(a['#'])||999)-(Number(b['#'])||999));
  tb.innerHTML = '';
  const pct = v => isNaN(Number(v))? '' : (Number(v)*100).toFixed(1)+'%';
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r['#']}</td>
      <td>${r['Name']}</td>
      <td>${r['Category']||''}</td>
      <td>${r['Start → Target']||''}</td>
      <td>${pct(r['Progress %'])}</td>
      <td>${pct(r['Consistency %'])}</td>
      <td>${Number(r['Final Score']||0).toFixed(2)}</td>`;
    tb.appendChild(tr);
  });
}

// Hours visuals
document.getElementById('refreshHours').onclick = loadHoursVisual;
let hoursChart;
async function loadHoursVisual(){
  const data = await getJSON();
  if(!data.ok) return;

  const ppl = (data.hours || []);
  const required = (data.settings && data.settings.requiredTotal) || (5*13);
  const labels = ppl.map(p=>p.name);
  const totals = ppl.map(p=>p.totalHours);

  // Chart: total hours vs required minimum
  const ctx = document.getElementById('hoursChart').getContext('2d');
  if (hoursChart) hoursChart.destroy();
  hoursChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Total Hours', data: totals },
        { label: 'Required Minimum', data: labels.map(()=>required) }
      ]
    },
    options: {
      responsive:true,
      plugins:{ legend:{ position:'bottom' } },
      scales:{ y:{ beginAtZero:true } }
    }
  });

  // Progress bars
  const wrap = document.getElementById('hoursBars');
  wrap.innerHTML = '';
  ppl.forEach(p=>{
    const pct = required ? Math.min(1, p.totalHours/required) : 0;
    const row = document.createElement('div');
    row.style.margin = '10px 0';
    row.innerHTML = `
      <div class="inline" style="justify-content:space-between;margin-bottom:6px">
        <strong>${p.name}</strong>
        <span class="muted">${p.totalHours.toFixed(1)} / ${required.toFixed(1)} hrs (${(pct*100).toFixed(1)}%)</span>
      </div>
      <div class="progress"><span style="width:${(pct*100).toFixed(1)}%"></span></div>
    `;
    wrap.appendChild(row);
  });

  // Update baseline pill
  const bpw = (data.settings && data.settings.baselinePerWeek) || 5;
  document.getElementById('baselineTag').textContent = `Baseline: ${bpw} hr/wk`;
}

// Initial loads
loadBoard();
loadHoursVisual();
</script>
</body>
</html>
